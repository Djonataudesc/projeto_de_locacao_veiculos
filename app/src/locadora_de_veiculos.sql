CREATE DATABASE IF NOT EXISTS locadora_de_veiculos;
USE locadora_de_veiculos;

CREATE TABLE tipo_veiculo (
cod VARCHAR(4) NOT NULL,
tamanho ENUM('PEQUENO', 'MÉDIO', 'GRANDE'),
nr_passageiro TINYINT,
nr_porta TINYINT,
km_media_dia SMALLINT NOT NULL,
nr_hr_limp TINYINT NOT NULL,
nr_hr_rev TINYINT NOT NULL,
cap_carga SMALLINT NOT NULL,

PRIMARY KEY (cod)
);

CREATE TABLE veiculo (
placa VARCHAR(7) NOT NULL,
chassis VARCHAR(17) NOT NULL,
nr_motor VARCHAR(9) NOT NULL,
disponivel BOOLEAN NOT NULL,
km_atual MEDIUMINT NOT NULL,
km_prox_rev MEDIUMINT NOT NULL,
cor VARCHAR(10),
cod_tipo_veiculo VARCHAR(4) NOT NULL,

PRIMARY KEY (placa),
FOREIGN KEY (cod_tipo_veiculo) REFERENCES tipo_veiculo(cod)
);

CREATE TABLE acessorio (
cod TINYINT NOT NULL AUTO_INCREMENT,
nome VARCHAR(20) NOT NULL,

PRIMARY KEY (cod)
);

CREATE TABLE tipo_veiculo_acessorio (
cod_tipo_veiculo VARCHAR(4) NOT NULL,
cod_acessorio TINYINT NOT NULL,

PRIMARY KEY (cod_tipo_veiculo, cod_acessorio),
FOREIGN KEY (cod_tipo_veiculo) REFERENCES tipo_veiculo(cod),
FOREIGN KEY (cod_acessorio) REFERENCES acessorio(cod)
);

CREATE TABLE endereco (
cod INT NOT NULL AUTO_INCREMENT,
nome VARCHAR(50) NOT NULL,
numero MEDIUMINT,
bairro VARCHAR(30),
municipio VARCHAR(30) NOT NULL,
uf VARCHAR(2) NOT NULL,

PRIMARY KEY (cod)
);

CREATE TABLE cliente_pj (
cnpj VARCHAR(14) NOT NULL,
razao_social VARCHAR(50) NOT NULL,
cod_endereco INT NOT NULL,

PRIMARY KEY (cnpj),
FOREIGN KEY (cod_endereco) REFERENCES endereco(cod)
);

CREATE TABLE motorista (
cpf VARCHAR(11) NOT NULL,
nome VARCHAR(20) NOT NULL,
sobrenome VARCHAR(30) NOT NULL,
sexo ENUM('F', 'M'),
dt_nasc DATE,
cnh VARCHAR(11) NOT NULL,
cnh_venc DATE NOT NULL,
cod_endereco INT NOT NULL,

PRIMARY KEY (cpf),
FOREIGN KEY (cod_endereco) REFERENCES endereco(cod)
);

CREATE TABLE cliente (
cod INT NOT NULL AUTO_INCREMENT,
cpf_motorista VARCHAR(11) NOT NULL,
cnpj_cliente_pj VARCHAR(14),

PRIMARY KEY (cod),
FOREIGN KEY (cpf_motorista) REFERENCES motorista(cpf),
FOREIGN KEY (cnpj_cliente_pj) REFERENCES cliente_pj(cnpj)
);

CREATE TABLE filial (
cnpj VARCHAR(14) NOT NULL,
cod_endereco INT NOT NULL,

PRIMARY KEY (cnpj),
FOREIGN KEY (cod_endereco) REFERENCES endereco(cod)
);

CREATE TABLE filial_veiculos (
placa_veiculo VARCHAR(7) NOT NULL,
cnpj_filial VARCHAR(14) NOT NULL,

PRIMARY KEY (placa_veiculo),
FOREIGN KEY (placa_veiculo) REFERENCES veiculo(placa),
FOREIGN KEY (cnpj_filial) REFERENCES filial(cnpj)
);

CREATE TABLE locacao (
cod INT NOT NULL AUTO_INCREMENT,
dt_hr_locacao DATETIME NOT NULL,
dt_hr_prevista DATETIME NOT NULL,
cod_cliente INT NOT NULL,
filial_destino VARCHAR(14) NOT NULL,
cod_tipo_veiculo_desejado VARCHAR(4) NOT NULL,
placa_veiculo VARCHAR(7) NOT NULL,

PRIMARY KEY (cod),
FOREIGN KEY (cod_cliente) REFERENCES cliente(cod),
FOREIGN KEY (filial_destino) REFERENCES filial(cnpj),
FOREIGN KEY (cod_tipo_veiculo_desejado) REFERENCES tipo_veiculo(cod),
FOREIGN KEY (placa_veiculo) REFERENCES veiculo(placa)
);

INSERT INTO `tipo_veiculo` VALUES ('CC10','Grande',2,2,600,3,3,1000),('CC20','Grande',3,2,800,3,3,2000),('ECMN','Pequeno',5,4,100,1,1,500),('EXMR','Médio',5,4,150,2,1,600),('JFAR','Grande',5,4,200,2,2,700),('PZAR','Médio',5,4,200,2,3,600),('SDAR','Pequeno',5,4,150,1,2,500),('XDAR','Grande',7,4,200,3,2,800);
INSERT INTO `veiculo` VALUES ('AAA1010','A1000000000000000','100000000',1,14921,15921,'BRANCO','ECMN'),('AAA1011','A1000000000000001','100000001',1,14671,15671,'PRATA','ECMN'),('AAA1012','A1000000000000002','100000002',1,18974,19974,'PRETO','ECMN'),('AAA1013','A1000000000000003','100000003',1,8851,10351,'BRANCO','EXMR'),('AAA1014','A1000000000000004','100000004',1,5012,6512,'PRATA','EXMR'),('AAA1015','A1000000000000005','100000005',1,4393,5893,'PRETO','EXMR'),('AAA1016','A1000000000000006','100000006',1,2616,4616,'BRANCO','JFAR'),('AAA1017','A1000000000000007','100000007',1,2695,4695,'PRATA','JFAR'),('AAA1018','A1000000000000008','100000008',1,18715,20715,'PRETO','JFAR'),('AAA1019','A1000000000000009','100000009',1,17294,19294,'BRANCO','PZAR'),('EEE2010','E1000000000000000','100000010',1,14387,16387,'PRATA','PZAR'),('EEE2011','E1000000000000001','100000011',1,10331,12331,'PRETO','PZAR'),('EEE2012','E1000000000000002','100000012',1,9563,11063,'BRANCO','SDAR'),('EEE2013','E1000000000000003','100000013',1,17440,18940,'PRATA','SDAR'),('EEE2014','E1000000000000004','100000014',1,15027,16527,'PRETO','SDAR'),('EEE2015','E1000000000000005','100000015',1,15267,17267,'BRANCO','XDAR'),('EEE2016','E1000000000000006','100000016',1,9973,11973,'PRATA','XDAR'),('EEE2017','E1000000000000007','100000017',1,6404,8404,'PRETO','XDAR'),('EEE2018','E1000000000000008','100000018',1,14781,20781,'BRANCO','CC10'),('EEE2019','E1000000000000009','100000019',1,14465,20465,'PRATA','CC10'),('XYZ3010','X1000000000000000','100000020',1,12269,18269,'PRETO','CC10'),('XYZ3011','X1000000000000001','100000021',1,11722,19722,'BRANCO','CC20'),('XYZ3012','X1000000000000002','100000022',1,6736,14736,'PRATA','CC20'),('XYZ3013','X1000000000000003','100000023',1,2684,10684,'PRETO','CC20');
INSERT INTO `acessorio` VALUES (1,'AR-CONDICIONADO'),(2,'DIREÇÃO HIDRÁULICA'),(3,'CÂMBIO AUTOMÁTICO'),(4,'AIR BAG'),(5,'ABS');
INSERT INTO `tipo_veiculo_acessorio` VALUES ('EXMR',1),('JFAR',1),('PZAR',1),('SDAR',1),('XDAR',1),('EXMR',2),('JFAR',2),('PZAR',2),('SDAR',2),('JFAR',3),('PZAR',3),('SDAR',3),('XDAR',3),('ECMN',4),('EXMR',4),('JFAR',4),('PZAR',4),('SDAR',4),('XDAR',4),('ECMN',5),('EXMR',5),('JFAR',5),('PZAR',5),('SDAR',5),('XDAR',5);
INSERT INTO `endereco` VALUES (1,'RUA UM',1,'CENTRO','SÃO BENTO DO SUL','SC'),(2,'RUA DOIS',2,'JARDINS','RIO NEGRINHO','SC'),(3,'RUA TRÊS',3,'CENTRO','CAMPO ALEGRE','SC'),(4,'RUA QUATRO',4,'MONTE VERDE','PIÊN','PR'),(5,'RUA CINCO',5,'CENTRO','SÃO BENTO DO SUL','SC'),(6,'RUA SEIS',6,'CENTRO','RIO NEGRINHO','SC'),(7,'RUA SETE',10,'JARDINS','CAMPO ALEGRE','SC'),(8,'RUA OITO',11,'CENTRO','PIÊN','PR'),(9,'RUA NOVE',12,'MONTE VERDE','SÃO BENTO DO SUL','SC'),(10,'AVENIDA MONTEIRO LOBATO',13,'CENTRO','RIO NEGRINHO','SC'),(11,'AVENIDA SANTOS DUMONT',14,'CENTRO','CAMPO ALEGRE','SC'),(12,'AVENIDA BRASIL',15,'JARDINS','PIÊN','PR'),(13,'RUA AMAZONAS',16,'CENTRO','SÃO BENTO DO SUL','SC'),(14,'RUA SÃO PAULO',100,'MONTE VERDE','RIO NEGRINHO','SC'),(15,'RUA SÃO JOÃO',101,'CENTRO','CAMPO ALEGRE','SC'),(16,'RUA SANTA MARIA',102,'CENTRO','PIÊN','PR');
INSERT INTO `cliente_pj` VALUES ('11111111111111','QUEIMA QUÍMICA',1),('22222222222222','HELLO MUNDO INTERNET',2),('33333333333333','ANTÔNIO TRANSPORTES',3);
INSERT INTO `motorista` VALUES ('11111111111','JOÃO','SILVA','M','1990-02-01','22222222222','2020-09-01',4),('11111111112','JOSÉ','OLIVEIRA','M','1990-02-02','22222222223','2020-09-11',5),('11111111113','MARIA','SANTOS','F','1990-02-03','22222222224','2020-09-15',6),('11111111114','ANA','SILVA','F','1980-03-10','22222222225','2020-09-25',7),('11111111115','JOÃO PEDRO','OLIVEIRA','M','1980-03-11','22222222226','2021-05-01',8),('11111111116','MARIA','SANTOS','F','1980-03-12','22222222227','2021-06-02',9),('11111111117','ALEX','SILVA','M','1980-03-13','22222222228','2022-02-01',10),('11111111118','LUCAS','OLIVEIRA','M','1970-04-20','22222222229','2023-07-22',11),('11111111119','RAFAEL','SANTOS','M','1970-04-21','22222222230','2023-09-09',12);
INSERT INTO `cliente` VALUES (1,'11111111111','11111111111111'),(2,'11111111112','22222222222222'),(3,'11111111113','33333333333333'),(4,'11111111114','11111111111111'),(5,'11111111111',NULL),(6,'11111111112',NULL),(7,'11111111115',NULL),(8,'11111111116',NULL),(9,'11111111117',NULL),(10,'11111111118',NULL),(11,'11111111119',NULL);
INSERT INTO `filial` VALUES ('99999999999999',13),('88888888888888',14);
INSERT INTO `filial_veiculos` VALUES ('AAA1010','88888888888888'),('AAA1012','88888888888888'),('AAA1014','88888888888888'),('AAA1016','88888888888888'),('AAA1018','88888888888888'),('EEE2010','88888888888888'),('EEE2012','88888888888888'),('EEE2014','88888888888888'),('EEE2016','88888888888888'),('EEE2018','88888888888888'),('XYZ3010','88888888888888'),('XYZ3012','88888888888888'),('AAA1011','99999999999999'),('AAA1013','99999999999999'),('AAA1015','99999999999999'),('AAA1017','99999999999999'),('AAA1019','99999999999999'),('EEE2011','99999999999999'),('EEE2013','99999999999999'),('EEE2015','99999999999999'),('EEE2017','99999999999999'),('EEE2019','99999999999999'),('XYZ3011','99999999999999'),('XYZ3013','99999999999999');

DELIMITER |

CREATE
	TRIGGER trg_locacao
    BEFORE INSERT
	ON locacao FOR EACH ROW
	BEGIN 
		DECLARE placa VARCHAR(7);
        
        SELECT v.placa
        INTO placa
        FROM veiculo v
        WHERE v.cod_tipo_veiculo = NEW.cod_tipo_veiculo_desejado AND disponivel = 1
        LIMIT 1;
        
        SET NEW.placa_veiculo = placa;
        
        UPDATE veiculo SET disponivel = 0 WHERE veiculo.placa = placa;
        
        UPDATE filial_veiculos SET cnpj_filial = NEW.filial_destino WHERE placa_veiculo = placa;
	END;
|

CREATE
	TRIGGER trg_veiculo
    BEFORE UPDATE
	ON veiculo FOR EACH ROW
	BEGIN
        IF (NEW.km_atual >= NEW.km_prox_rev) THEN            
            SET @km_media = (SELECT km_media_dia FROM tipo_veiculo WHERE cod = NEW.cod_tipo_veiculo);
            SET NEW.km_prox_rev = NEW.km_atual + @km_media * 10;
        END IF;
	END;
|

DELIMITER ;

INSERT INTO `locacao`(dt_hr_locacao, dt_hr_prevista, cod_cliente, filial_destino, cod_tipo_veiculo_desejado) VALUES ('2020-09-11 18:00:00','2020-09-12 18:00:00',1,'99999999999999','CC10'),('2020-09-12 08:00:00','2020-09-13 16:00:00',5,'88888888888888','JFAR'),('2020-09-12 11:00:00','2020-09-13 22:00:00',7,'99999999999999','ECMN'),('2020-09-12 18:00:00','2020-09-27 08:00:00',8,'88888888888888','EXMR');


-- MODELO DE INSERT
-- INSERT INTO `locacao`(dt_hr_locacao, dt_hr_prevista, cod_cliente, filial_destino, cod_tipo_veiculo_desejado) VALUES ('2020-09-11 18:00:00','2020-09-12 18:00:00',1,'99999999999999','CC10')